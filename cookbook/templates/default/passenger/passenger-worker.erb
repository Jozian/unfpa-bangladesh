#!/bin/bash
#This file is generated by Chef
#Based on Systemd integration presented here:
#https://github.com/mtgrosser/passenger-systemd

warn () { echo -e "$1" >&2; }

usage() {
  cat <<EOD
Usage: passenger-app <command> [<args>]

Commands:
   start     Start application <app>
   reload    Reload application <app>
   stop      Stop application <app>
   restart   Restart application <app>
   status    Run passenger-status with <args>
   config    Run passenger-config with <args>
EOD
}

init() {
  source <%= ::File.join(node[:primero][:home_dir],'.rvm','scripts','rvm') %>
  APPDIR=<%= node[:primero][:app_dir] %>
  PIDFILE=<%= @passenger_pid %>
  LOGFILE=<%= @passenger_log %>
  MAX_POOL_SIZE=<%= @conf['max_pool_size'] || 6 %>
  MIN_INSTANCES=<%= @conf['min_instances'] || 1 %>
  export RAILS_LOG_PATH=<%= @rails_log_dir %>
  export PASSENGER_TEMP_DIR=<%= node[:primero][:app_dir] %>/tmp
  export CHECK_ONLINE_STATUS=<%= node[:primero][:check_online_status] %>
  cd "$APPDIR"
}

config() {
  bundle exec passenger-config "$@"
}

status() {
  bundle exec passenger-status "$@"
}

start() {
  bundle exec passenger start \
    --daemonize \
    --address 127.0.0.1 \
    --port 4000 \
    --log-file ${LOGFILE} \
    --pid-file ${PIDFILE} \
    --max-pool-size ${MAX_POOL_SIZE} \
    --min-instances ${MIN_INSTANCES} \
    --sticky-sessions \
    --environment production
}

reload() {
  bundle exec passenger-config restart-app "$APPDIR"
}

stop() {
  bundle exec passenger stop --pid-file ${PIDFILE}
}

restart() {
  echo "Shutting down application ..."
  stop
  sleep 5
  start
}

ACTION=$1; shift
init


case "$ACTION" in
  help)
    usage && exit 0
  ;;
  start)
    start
  ;;
  reload)
    reload
  ;;
  stop)
    stop
  ;;
  restart)
    restart
  ;;
  status)
    status $@
  ;;
  config)
    config $@
  ;;
  *)
    usage && exit 1
  ;;
esac
